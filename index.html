<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Air Traffic Routes — Flight Control Variant</title>
  <style>
    html,body { height:100%; margin:0; font-family: Inter, system-ui, Arial, sans-serif; background:#000; color:#1e293b; -webkit-tap-highlight-color: transparent; overflow: hidden; }
    #game { display:flex; height:100vh; }
    #canvasWrap { flex:1; position:relative; touch-action: none; cursor: crosshair; }
    canvas { display:block; width:100%; height:100%; background: linear-gradient(135deg,#0b1020 0%, #0f172a 60%, #111827 100%); transition: filter 0.3s ease; }

    /* Radar grid overlay */
    .radar-grid { position:absolute; inset:0; pointer-events:none; background:
      radial-gradient(circle at 50% 50%, rgba(59,130,246,0.05) 0 2px, transparent 2px 100%),
      repeating-radial-gradient(circle at 50% 50%, rgba(59,130,246,0.07), rgba(59,130,246,0.07) 1px, transparent 1px 40px),
      repeating-linear-gradient(0deg, rgba(59,130,246,0.06), rgba(59,130,246,0.06) 1px, transparent 1px 40px),
      repeating-linear-gradient(90deg, rgba(59,130,246,0.06), rgba(59,130,246,0.06) 1px, transparent 1px 40px);
      mix-blend-mode: screen;
    }
    /* Enhanced radar sweep overlay */
    .radar-sweep { position:absolute; inset:0; pointer-events:none; background:
      conic-gradient(from 0deg at 50% 50%, rgba(34,197,94,0.0), rgba(34,197,94,0.0) 330deg, rgba(34,197,94,0.35));
      animation: sweep-rotate 6s linear infinite; mix-blend-mode: screen; filter: blur(1px);
      opacity: 0.8; transition: opacity 0.3s ease; }
    .radar-sweep::after { content: ''; position: absolute; inset: 0; background:
      radial-gradient(circle at 50% 50%, rgba(34,197,94,0.05) 0%, transparent 70%);
      animation: pulse-radar 3s ease-in-out infinite; }
    @keyframes sweep-rotate { to { transform: rotate(360deg); } }
    @keyframes pulse-radar { 0%, 100% { opacity: 0.3; } 50% { opacity: 0.7; } }
    @keyframes weather-pulse { 0%, 100% { opacity: 0; transform: scale(1); } 50% { opacity: 0.6; transform: scale(1.2); } }

    /* Enhanced slider styling */
    input[type="range"] {
      -webkit-appearance: none;
      appearance: none;
      background: transparent;
      cursor: pointer;
    }
    input[type="range"]::-webkit-slider-track {
      background: #374151;
      height: 6px;
      border-radius: 3px;
    }
    input[type="range"]::-webkit-slider-thumb {
      -webkit-appearance: none;
      appearance: none;
      height: 18px;
      width: 18px;
      border-radius: 50%;
      background: linear-gradient(135deg, #8b5cf6, #7c3aed);
      border: 2px solid #ffffff;
      box-shadow: 0 2px 6px rgba(0,0,0,0.3);
      transition: all 0.2s ease;
    }
    input[type="range"]::-webkit-slider-thumb:hover {
      transform: scale(1.1);
      box-shadow: 0 4px 12px rgba(139,92,246,0.4);
    }
    input[type="range"]::-moz-range-track {
      background: #374151;
      height: 6px;
      border-radius: 3px;
      border: none;
    }
    input[type="range"]::-moz-range-thumb {
      height: 18px;
      width: 18px;
      border-radius: 50%;
      background: linear-gradient(135deg, #8b5cf6, #7c3aed);
      border: 2px solid #ffffff;
      box-shadow: 0 2px 6px rgba(0,0,0,0.3);
      cursor: pointer;
      transition: all 0.2s ease;
    }

    /* Setting group spacing */
    .setting-group {
      margin-bottom: 20px;
    }

    /* Traffic alert pulse */
    #canvasWrap.traffic-alert::after { content:''; position:absolute; inset:0; pointer-events:none; background: radial-gradient(circle at 50% 50%, rgba(239,68,68,0.08), transparent 50%); animation: alert-pulse 1s ease-out; }
    @keyframes alert-pulse { 0% { opacity: 0.8; } 100% { opacity: 0; } }

    #topLeftHud { position: absolute; top: 16px; left: 16px; z-index: 15; display: flex; align-items: center; gap: 18px; }
    .tl-icon { width: 36px; height: 36px; border-radius: 10px; cursor: pointer; display: flex; align-items: center; justify-content: center; color: #e5e7eb; background: rgba(17,24,39,0.7); border: 1px solid rgba(255,255,255,0.08); box-shadow: 0 2px 8px rgba(0,0,0,0.5); transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1); backdrop-filter: blur(8px); font-size: 18px; }
    .tl-icon:hover { background: rgba(31,41,55,0.85); transform: translateY(-1px) scale(1.05); box-shadow: 0 4px 12px rgba(0,0,0,0.6); }
    .tl-icon:active { transform: translateY(0) scale(0.95); transition-duration: 0.1s; }

    /* Auto-routing toggle styling */
    .auto-routing-toggle { position: relative; padding: 4px; display: flex; align-items: center; justify-content: center; }
    .toggle-switch { position: absolute; width: 28px; height: 16px; background: #374151; border-radius: 8px; transition: all 0.3s ease; }
    .toggle-slider { position: absolute; top: 2px; left: 2px; width: 12px; height: 12px; background: #6b7280; border-radius: 50%; transition: all 0.3s ease; }
    .toggle-icon { position: relative; z-index: 2; font-size: 16px; transition: all 0.3s ease; }

    .auto-routing-toggle.active .toggle-switch { background: #10b981; }
    .auto-routing-toggle.active .toggle-slider { transform: translateX(12px); background: #ffffff; box-shadow: 0 2px 4px rgba(0,0,0,0.2); }
    .auto-routing-toggle.active .toggle-icon { color: #10b981; }

    .auto-routing-toggle:hover .toggle-switch { background: #4b5563; }
    .auto-routing-toggle.active:hover .toggle-switch { background: #059669; }
    #promoBanner { font-weight: 700; color: #f3f4f6; font-size: 15px; letter-spacing: 0.2px; background: linear-gradient(135deg, #ef4444, #f59e0b); padding: 10px 16px; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.4); border: 1px solid rgba(255,255,255,0.08); transition: transform 0.2s ease; }
    #promoBanner:hover { transform: translateY(-1px); }

    #topRightHud { position: absolute; top: 16px; right: 16px; z-index: 15; display: flex; flex-direction: column; align-items: flex-end; gap: 0; user-select: none; }
    #dayBadge { display: inline-flex; align-items: center; gap: 12px; color: #e5e7eb; font-weight: 700; font-size: 18px; letter-spacing: 0.5px; background: rgba(17,24,39,0.8); padding: 14px 20px; border-radius: 16px; border: 1px solid rgba(255,255,255,0.1); box-shadow: 0 4px 12px rgba(0,0,0,0.6); backdrop-filter: blur(12px); transition: all 0.3s ease; text-shadow: 0 1px 3px rgba(0,0,0,0.8); }
    #dayClock { width: 28px; height: 28px; border-radius: 50%; background: conic-gradient(#f59e0b 0deg, #f59e0b 0deg, rgba(255,255,255,0.12) 0deg 360deg); box-shadow: 0 0 0 2px rgba(0,0,0,0.3) inset; transition: transform 0.3s ease; }
    #speedControls { display: flex; flex-direction: column; gap: 4px; background: rgba(17,24,39,0.7); border: 1px solid rgba(255,255,255,0.06); padding: 8px; border-radius: 16px; box-shadow: 0 2px 8px rgba(0,0,0,0.5); backdrop-filter: blur(8px); }
    .speed-btn { width: 28px; height: 24px; display: inline-flex; align-items: center; justify-content: center; border: 0; border-radius: 6px; background: transparent; color: #f3f4f6; cursor: pointer; font-size: 12px; font-weight: 700; transition: all 0.2s ease; }
    .speed-btn.active { background: #0ea5a3; color: white; box-shadow: 0 2px 4px rgba(14,165,163,0.3); }
    .speed-btn:hover:not(.active) { background: rgba(255,255,255,0.08); }

    #bottomShelf { position: absolute; left: 50%; bottom: 12px; transform: translateX(-50%); z-index: 15; display: flex; align-items: center; gap: 18px; background: rgba(17,24,39,0.85); border: 1px solid rgba(255,255,255,0.12); border-radius: 32px; padding: 12px 18px; backdrop-filter: blur(16px); box-shadow: 0 4px 20px rgba(0,0,0,0.5), 0 1px 0 rgba(255,255,255,0.1) inset; transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); }
    #bottomShelf:hover { transform: translateX(-50%) translateY(-3px) scale(1.02); box-shadow: 0 8px 30px rgba(0,0,0,0.8), 0 1px 0 rgba(255,255,255,0.15) inset; }
    .inv-pill { display: flex; align-items: center; gap: 12px; color: #e5e7eb; transition: transform 0.2s ease; }
    .inv-pill:hover { transform: scale(1.05); }
    .inv-icon { width: 48px; height: 48px; border-radius: 50%; background: linear-gradient(135deg, #1f2937, #111827); color: #fff; display: flex; align-items: center; justify-content: center; font-size: 24px; box-shadow: 0 2px 8px rgba(0,0,0,0.5), 0 1px 0 rgba(255,255,255,0.1) inset; transition: all 0.2s ease; }
    .inv-count { font-weight: 700; font-size: 20px; min-width: 24px; text-align: center; transition: color 0.2s ease; text-shadow: 0 1px 2px rgba(0,0,0,0.5); }
    #lineSwatches { display: flex; align-items: center; gap: 16px; padding: 0 12px; }
    .swatch { width: 32px; height: 32px; border-radius: 50%; box-shadow: 0 2px 6px rgba(0,0,0,0.6), 0 0 0 2px rgba(255,255,255,0.12) inset; cursor: pointer; transition: all 0.25s cubic-bezier(0.4, 0, 0.2, 1); position: relative; border: 2px solid transparent; }
    .swatch:hover { transform: scale(1.15) translateY(-1px); box-shadow: 0 8px 20px rgba(0,0,0,0.8), 0 0 0 2px rgba(255,255,255,0.25) inset, 0 0 12px rgba(255,255,255,0.1); z-index: 2; }
    .swatch.selected { transform: scale(1.3) !important; border: 3px solid #ffffff !important; box-shadow: 0 0 0 1px rgba(0,0,0,0.8), 0 6px 16px rgba(0,0,0,0.9), 0 0 16px rgba(255,255,255,0.2) !important; z-index: 3; }
    .swatch.selected::after { content: '●'; position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); color: rgba(255,255,255,0.95); font-size: 12px; text-shadow: 0 0 4px rgba(0,0,0,1); }

    #gameOver, #rewardDialog { position: absolute; inset: 0; display: none; align-items: center; justify-content: center; z-index: 20; }
    #gameOver.show, #rewardDialog.show { display: flex; }
    .box { background: linear-gradient(180deg, rgba(17,24,39,0.95), rgba(15,23,42,0.95)); color: #e5e7eb; padding: 16px 18px; border-radius: 12px; border: 1px solid rgba(255,255,255,0.08); box-shadow: 0 10px 40px rgba(0,0,0,0.6), 0 1px 0 rgba(255,255,255,0.08) inset; min-width: 320px; max-width: 480px; transform: translateY(6px) scale(0.98); opacity: 0; transition: all 0.25s ease; }
    #gameOver.show .box, #rewardDialog.show .box { opacity: 1; transform: translateY(0) scale(1); }
    h2 { margin: 0 0 8px 0; font-size: 18px; letter-spacing: 0.6px; }
    p { margin: 0; font-size: 13px; color: #cbd5e1; }
    button { background: #0ea5a3; color: #fff; border: 0; padding: 8px 10px; border-radius: 8px; font-weight: 700; cursor: pointer; box-shadow: 0 2px 8px rgba(14,165,163,0.35); transition: all 0.2s ease; }
    button.secondary { background: #334155; box-shadow: none; }
    button:hover { filter: brightness(1.05); transform: translateY(-1px); }

    /* Cursor states */
    .canvas-drawing { cursor: crosshair !important; }
    .canvas-hovering-station { cursor: pointer !important; }
    .canvas-hovering-line { cursor: grab !important; }
    .canvas-removing { cursor: not-allowed !important; }
    .canvas-recoloring { cursor: help !important; }

    /* Enhanced achievement notifications */
    .achievement-notification { position: fixed; top: 20px; right: 20px; z-index: 1000; background: linear-gradient(135deg, #1f2937, #111827); border: 2px solid #f59e0b; border-radius: 12px; padding: 16px; box-shadow: 0 10px 30px rgba(0,0,0,0.7), 0 0 20px rgba(245,158,11,0.3), 0 2px 0 rgba(245,158,11,0.2) inset; transform: translateX(120%); opacity: 0; transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275); max-width: 300px; }
    .achievement-notification.show { transform: translateX(0) scale(1.02); opacity: 1; }
    .achievement-notification:hover { transform: translateX(-5px) scale(1.03); }
    .achievement-content { display: flex; align-items: center; gap: 12px; color: #e5e7eb; }
    .achievement-icon { font-size: 32px; flex-shrink: 0; animation: bounce-icon 0.6s ease-out; }
    .achievement-title { font-size: 12px; font-weight: 700; color: #f59e0b; text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 2px; text-shadow: 0 1px 2px rgba(0,0,0,0.5); }
    .achievement-name { font-size: 14px; font-weight: 700; color: #fff; margin-bottom: 2px; text-shadow: 0 1px 2px rgba(0,0,0,0.5); }
    .achievement-desc { font-size: 12px; color: #cbd5e1; line-height: 1.3; }
    @keyframes bounce-icon { 0% { transform: scale(0.3); } 50% { transform: scale(1.1); } 100% { transform: scale(1); } }

    /* Event notifications */
    .event-notification { position: fixed; top: 20px; left: 20px; z-index: 999; background: linear-gradient(135deg, #1f2937, #111827); border: 2px solid #ef4444; border-radius: 12px; padding: 16px; box-shadow: 0 10px 30px rgba(0,0,0,0.7), 0 0 20px rgba(239,68,68,0.3); transform: translateX(-120%); opacity: 0; transition: all 0.3s ease; max-width: 300px; }
    .event-notification.show { transform: translateX(0); opacity: 1; }
    .event-content { display: flex; align-items: center; gap: 12px; color: #e5e7eb; }
    .event-icon { font-size: 28px; flex-shrink: 0; }
    .event-title { font-size: 12px; font-weight: 700; color: #ef4444; text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 2px; }
    .event-name { font-size: 14px; font-weight: 700; color: #fff; margin-bottom: 2px; }
    .event-desc { font-size: 12px; color: #cbd5e1; line-height: 1.3; }

    /* Enhanced mobile responsiveness */
    @media (max-width:640px){
      #bottomShelf { gap: 16px; padding: 12px 18px; border-radius: 32px; }
      .inv-icon { width: 36px; height: 36px; font-size: 18px; }
      .inv-count { font-size: 16px; }
      .swatch { width: 24px; height: 24px; }
      .swatch:hover { transform: scale(1.2) translateY(-1px); }
      .swatch.selected { transform: scale(1.4) !important; }
      #lineSwatches { gap: 12px; }
      #topRightHud { gap: 12px; flex-wrap: wrap; }
      #topLeftHud { gap: 14px; flex-wrap: wrap; }
      .tl-icon { width: 34px; height: 34px; font-size: 17px; }
      #dayBadge { font-size: 14px; padding: 10px 14px; }
      #dayClock { width: 24px; height: 24px; }
      .achievement-notification { top: 10px; right: 10px; max-width: 280px; padding: 12px; font-size: 90%; }
      .achievement-icon { font-size: 24px; }
      #complexityIndicator, #achievementProgress { padding: 8px 12px; }
      #complexityIndicator > div, #achievementProgress > div { gap: 2px; }
      #complexityLevel, #achievementCount { font-size: 14px; }
      #complexityIcon, #achievementProgress span { font-size: 20px; }
      .speed-btn { width: 32px; height: 28px; font-size: 14px; }
    }
  </style>
  <!-- Fallback note for local file loads -->
  <meta name="airspace-warning" content="Serve via a local web server if blank." />
  </head>
<body>
  <div id="game">
    <div id="canvasWrap">
      <canvas id="c"></canvas>
      <div id="moduleWarning" style="position:absolute;left:50%;top:50%;transform:translate(-50%,-50%);background:rgba(0,0,0,0.75);color:#fff;padding:14px 18px;border-radius:10px;z-index:1000;max-width:480px;text-align:center;">
        If this page appears blank, you likely opened it directly from the filesystem.
        Please serve the folder via a local web server, for example:<br><br>
        <code>python -m http.server 8000</code><br>
        then open <code>http://localhost:8000/flight_control.html</code>.
      </div>

      <!-- Style overlays -->
      <div class="radar-grid"></div>
      <div class="radar-sweep"></div>

      <!-- ATC toast -->
      <div id="atcToast" style="position:absolute;left:50%;top:12px;transform:translateX(-50%) translateY(-8px);opacity:0;background:rgba(17,24,39,0.85);color:#fff;padding:6px 10px;border-radius:10px;border:1px solid rgba(255,255,255,0.08);box-shadow:0 2px 10px rgba(0,0,0,0.4);transition:all .25s ease;pointer-events:none;z-index:25;">Traffic alert</div>

      <div id="topLeftHud">
        <div id="btnHelp" class="tl-icon" title="Show Flight Control Guide (F1)" style="background: linear-gradient(135deg, #0ea5a3, #059669);">?</div>
        <div id="btnSettings" class="tl-icon" title="Difficulty Settings (P)" style="background: linear-gradient(135deg, #8b5cf6, #7c3aed);">⚙️</div>
        <div id="btnBack" class="tl-icon" title="Back">←</div>
        <div id="btnUndo" class="tl-icon" title="Undo Last Action (Ctrl+Z)" style="opacity: 0.4;">↶</div>
        <div id="btnAutoRoute" class="tl-icon auto-routing-toggle" title="Toggle Auto-Routing (A)">
          <div class="toggle-switch">
            <div class="toggle-slider"></div>
          </div>
          <span class="toggle-icon">🤖</span>
        </div>
        <div id="btnOpen" class="tl-icon" title="Open">↗</div>
      </div>

      <div id="topRightHud">
        <div style="display: flex; align-items: center; gap: 16px;">
          <div id="dayBadge">
            <span id="dayLabel">MON</span>
            <div id="dayClock" aria-hidden="true"></div>
          </div>
          <div id="speedControls">
            <button id="btnPause" class="speed-btn" title="Pause">⏸</button>
            <button id="btnPlay" class="speed-btn" title="Play">▶</button>
            <button id="btnFast" class="speed-btn" title="2x Speed">⏩</button>
          </div>
        </div>
        <div style="display: flex; justify-content: flex-end; margin-top: 12px;">
          <div id="achievementProgress" title="Achievement Progress" style="display: flex; align-items: center; gap: 12px; background: rgba(17,24,39,0.7); padding: 10px 14px; border-radius: 14px; border: 1px solid rgba(255,255,255,0.06); backdrop-filter: blur(8px);">
            <span style="font-size: 22px;">🏆</span>
            <div style="display: flex; flex-direction: column; gap: 4px;">
              <div id="achievementCount" style="font-size: 15px; font-weight: 700; color: #f59e0b; text-shadow: 0 1px 2px rgba(0,0,0,0.6);">0/12</div>
              <div style="width: 80px; height: 5px; background: rgba(255,255,255,0.1); border-radius: 3px; overflow: hidden;">
                <div id="achievementBar" style="height: 100%; background: linear-gradient(90deg, #f59e0b, #ef4444); width: 0%; transition: width 0.3s ease;"></div>
              </div>
            </div>
          </div>
        </div>
        <div style="display: flex; justify-content: flex-end; margin-top: 8px;">
          <div id="complexityIndicator" title="Network Complexity" style="display: flex; align-items: center; gap: 10px; background: rgba(17,24,39,0.7); padding: 8px 12px; border-radius: 12px; border: 1px solid rgba(255,255,255,0.06); backdrop-filter: blur(8px); transform: scale(0.85);">
            <span id="complexityIcon" style="font-size: 18px;">🧠</span>
            <div style="display: flex; flex-direction: column; gap: 3px;">
              <div id="complexityLevel" style="font-size: 13px; font-weight: 700; color: #10b981; text-shadow: 0 1px 2px rgba(0,0,0,0.6);">LOW</div>
              <div style="width: 68px; height: 4px; background: rgba(255,255,255,0.1); border-radius: 2px; overflow: hidden;">
                <div id="complexityBar" style="height: 100%; background: linear-gradient(90deg, #10b981, #f59e0b, #ef4444); width: 20%; transition: width 0.3s ease;"></div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <div id="bottomShelf">
        <div class="inv-pill" id="trainPill" title="Available Aircraft - Planes ready to deploy on new routes"><span class="inv-icon" aria-hidden="true">🛩️</span><span id="invTrains" class="inv-count">0</span></div>
        <div id="lineSwatches" aria-label="Flight Route Colors - Select color for new routes"></div>
        <div class="inv-pill" id="tunnelPill" title="Airspace Permits - Required to cross restricted airspace (red zone)"><span class="inv-icon" aria-hidden="true">🛂</span><span id="invTunnels" class="inv-count">0</span></div>
        <div class="inv-pill" id="carriagePill" title="Capacity Upgrades - Additional passenger capacity for aircraft"><span class="inv-icon" aria-hidden="true">🧳</span><span id="invCarriages" class="inv-count">0</span></div>
        <div class="inv-pill" id="wxPill" title="Weather Systems - Active storm cells that slow aircraft (Press W to toggle)"><span class="inv-icon" aria-hidden="true" style="position: relative;">
          ⛈️
          <div id="weatherPulse" style="position: absolute; inset: -2px; border-radius: 50%; background: rgba(59,130,246,0.2); animation: weather-pulse 2s ease-in-out infinite; opacity: 0;"></div>
        </span><span id="wxCount" class="inv-count">0</span></div>
      </div>

      <div id="gameOver">
        <div class="box">
          <h2>Control Lost</h2>
          <p id="goReason">An airport became overcrowded.</p>
          <p id="finalStats"></p>
          <div style="display:flex;gap:12px;justify-content:center;margin-top:20px;">
            <button id="goRestart">Try Again</button>
            <button id="goClose" class="secondary">Close</button>
          </div>
        </div>
      </div>

      <div id="rewardDialog">
        <div class="box">
          <h2>Week Complete!</h2>
          <p>You received a new plane! Choose your weekly reward:</p>
          <div class="reward-options" id="rewardOptions" style="display:grid; grid-template-columns: repeat(3, minmax(0,1fr)); gap: 10px; margin-top: 12px;"></div>
          <p style="font-size:12px; color:#9fb4c8; margin-top:15px;">Choose wisely — each option helps in different ways</p>
        </div>
      </div>

      <!-- Route Suggestions Panel -->
      <div id="suggestionsPanel" style="position: absolute; bottom: 20px; left: 20px; z-index: 10; background: rgba(17,24,39,0.9); border: 1px solid rgba(255,255,255,0.1); border-radius: 12px; padding: 12px; max-width: 280px; transform: translateY(100px); opacity: 0; transition: all 0.3s ease; backdrop-filter: blur(12px);">
        <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 8px;">
          <span style="font-size: 16px;">💡</span>
          <span style="font-size: 12px; font-weight: 700; color: #f59e0b; text-transform: uppercase; letter-spacing: 0.5px;">Route Suggestions</span>
        </div>
        <div id="suggestionsList" style="display: flex; flex-direction: column; gap: 6px;"></div>
      </div>

      <!-- Enhanced Help & Tutorial System -->
      <div id="helpOverlay" style="position: absolute; inset: 0; z-index: 100; background: rgba(0,0,0,0.85); display: none; align-items: center; justify-content: center; backdrop-filter: blur(4px);">
        <div style="background: linear-gradient(135deg, #1f2937, #111827); border: 2px solid #0ea5a3; border-radius: 16px; padding: 24px; max-width: 600px; max-height: 80vh; overflow-y: auto;">
          <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 20px;">
            <h2 style="color: #0ea5a3; margin: 0; font-size: 24px;">✈️ Flight Control Guide</h2>
            <button id="closeHelp" style="background: transparent; border: none; color: #94a3b8; font-size: 24px; cursor: pointer; padding: 4px;">×</button>
          </div>

          <div style="color: #e5e7eb; line-height: 1.6;">
            <h3 style="color: #f59e0b; margin-top: 0;">🎯 Objective</h3>
            <p>Manage air traffic routes between airports. Transport passengers to their destinations efficiently while avoiding overcrowding.</p>

            <h3 style="color: #f59e0b;">🎮 Controls</h3>
            <div style="display: grid; grid-template-columns: auto 1fr; gap: 8px 16px; font-family: monospace; font-size: 14px;">
              <strong>Drag</strong><span>Connect airports to create flight routes</span>
              <strong>Shift+Drag</strong><span>Force new route (instead of extending)</span>
              <strong>Alt+Click</strong><span>Remove flight routes</span>
              <strong>1-7 Keys</strong><span>Select route colors</span>
              <strong>Tab</strong><span>Cycle through route colors</span>
              <strong>Ctrl+Z</strong><span>Undo last action</span>
              <strong>A</strong><span>Toggle auto-routing assistance</span>
              <strong>D</strong><span>Toggle passenger flow debug view</span>
              <strong>W</strong><span>Toggle weather systems</span>
            </div>

            <h3 style="color: #f59e0b;">🏢 Airport Types</h3>
            <div style="display: flex; gap: 16px; margin: 12px 0;">
              <div style="text-align: center;">
                <div style="width: 40px; height: 40px; border-radius: 50%; background: #ffffff; border: 3px solid #3b3b3b; margin: 0 auto 8px; position: relative;">
                  <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 16px; height: 16px; border: 2px solid #2f2f2f; border-radius: 50%;"></div>
                </div>
                <div style="font-size: 12px; color: #94a3b8;">Regional</div>
              </div>
              <div style="text-align: center;">
                <div style="width: 40px; height: 40px; border-radius: 50%; background: #ffffff; border: 6px solid #111827; margin: 0 auto 8px; position: relative;">
                  <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 16px; height: 16px; border: 2px solid #2f2f2f; border-radius: 50%;"></div>
                </div>
                <div style="font-size: 12px; color: #94a3b8;">Hub</div>
              </div>
              <div style="text-align: center;">
                <div style="width: 40px; height: 40px; border-radius: 50%; background: #ffffff; border: 3px solid #f59e0b; margin: 0 auto 8px; position: relative; box-shadow: 0 0 12px rgba(245,158,11,0.4);">
                  <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 16px; height: 16px; border: 2px solid #2f2f2f; border-radius: 50%;"></div>
                  <div style="position: absolute; top: -8px; left: 50%; transform: translateX(-50%); color: #f59e0b; font-size: 12px;">★</div>
                </div>
                <div style="font-size: 12px; color: #f59e0b;">International</div>
              </div>
            </div>

            <h3 style="color: #f59e0b;">⚡ Pro Tips</h3>
            <ul style="margin: 0; padding-left: 20px;">
              <li>Connect regional airports to International hubs (★) for higher scores</li>
              <li>Use tunnel permits to cross restricted airspace (red zone)</li>
              <li>Watch for weather cells that slow aircraft</li>
              <li>Lines with animated chevrons show flight direction</li>
              <li>Extend routes from endpoint airports, not hub centers</li>
              <li>Weekly rewards help expand your network strategically</li>
            </ul>
          </div>
        </div>
      </div>

      <!-- Quick Tips Tooltip -->
      <div id="quickTip" style="position: absolute; z-index: 50; background: rgba(17,24,39,0.95); color: #e5e7eb; padding: 10px 14px; border-radius: 10px; font-size: 14px; font-weight: 600; pointer-events: none; opacity: 0; transition: all 0.2s ease; border: 1px solid rgba(255,255,255,0.2); backdrop-filter: blur(12px); max-width: 240px; text-align: center; box-shadow: 0 4px 16px rgba(0,0,0,0.6); text-shadow: 0 1px 2px rgba(0,0,0,0.8);"></div>

      <!-- Difficulty Settings Panel -->
      <div id="settingsOverlay" style="position: absolute; inset: 0; z-index: 90; background: rgba(0,0,0,0.85); display: none; align-items: center; justify-content: center; backdrop-filter: blur(4px);">
        <div style="background: linear-gradient(135deg, #1f2937, #111827); border: 2px solid #8b5cf6; border-radius: 16px; padding: 24px; max-width: 700px; max-height: 85vh; overflow-y: auto; min-width: 600px;">
          <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 20px;">
            <h2 style="color: #8b5cf6; margin: 0; font-size: 24px;">⚙️ Difficulty Settings</h2>
            <button id="closeSettings" style="background: transparent; border: none; color: #94a3b8; font-size: 24px; cursor: pointer; padding: 4px;">×</button>
          </div>

          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 24px; color: #e5e7eb;">
            <!-- Traffic Management -->
            <div>
              <h3 style="color: #f59e0b; margin: 0 0 16px 0; font-size: 18px;">🚁 Traffic Management</h3>

              <div class="setting-group">
                <label style="display: block; font-weight: 600; margin-bottom: 8px; color: #cbd5e1;">
                  Passenger Spawn Rate
                  <span style="color: #64748b; font-weight: 400; font-size: 12px;">(lower = more passengers)</span>
                </label>
                <div style="display: flex; align-items: center; gap: 12px;">
                  <span style="font-size: 12px; color: #64748b; min-width: 40px;">Fast</span>
                  <input type="range" id="spawnRate" min="0.3" max="2.0" step="0.1" value="0.85"
                         style="flex: 1; height: 6px; background: #374151; border-radius: 3px; outline: none; cursor: pointer;">
                  <span style="font-size: 12px; color: #64748b; min-width: 40px;">Slow</span>
                </div>
                <div style="font-size: 11px; color: #6b7280; margin-top: 4px;">Current: <span id="spawnRateValue">0.85</span>x</div>
              </div>

              <div class="setting-group" style="margin-top: 20px;">
                <label style="display: block; font-weight: 600; margin-bottom: 8px; color: #cbd5e1;">
                  Maximum Wait Time
                  <span style="color: #64748b; font-weight: 400; font-size: 12px;">(before passenger frustration)</span>
                </label>
                <div style="display: flex; align-items: center; gap: 12px;">
                  <span style="font-size: 12px; color: #64748b; min-width: 40px;">120s</span>
                  <input type="range" id="maxWaitTime" min="120" max="300" step="15" value="200"
                         style="flex: 1; height: 6px; background: #374151; border-radius: 3px; outline: none; cursor: pointer;">
                  <span style="font-size: 12px; color: #64748b; min-width: 40px;">300s</span>
                </div>
                <div style="font-size: 11px; color: #6b7280; margin-top: 4px;">Current: <span id="maxWaitValue">200</span>s</div>
              </div>

              <div class="setting-group" style="margin-top: 20px;">
                <label style="display: block; font-weight: 600; margin-bottom: 8px; color: #cbd5e1;">
                  Connection Time Multiplier
                  <span style="color: #64748b; font-weight: 400; font-size: 12px;">(minimum connection time at hubs)</span>
                </label>
                <div style="display: flex; align-items: center; gap: 12px;">
                  <span style="font-size: 12px; color: #64748b; min-width: 40px;">0.3x</span>
                  <input type="range" id="mctMultiplier" min="0.3" max="1.5" step="0.1" value="0.5"
                         style="flex: 1; height: 6px; background: #374151; border-radius: 3px; outline: none; cursor: pointer;">
                  <span style="font-size: 12px; color: #64748b; min-width: 40px;">1.5x</span>
                </div>
                <div style="font-size: 11px; color: #6b7280; margin-top: 4px;">Current: <span id="mctValue">0.5</span>x</div>
              </div>
            </div>

            <!-- Network Strategy -->
            <div>
              <h3 style="color: #f59e0b; margin: 0 0 16px 0; font-size: 18px;">🌐 Network Strategy</h3>

              <div class="setting-group">
                <label style="display: flex; align-items: center; gap: 12px; font-weight: 600; color: #cbd5e1; cursor: pointer;">
                  <div style="position: relative; width: 50px; height: 28px; background: #374151; border-radius: 14px; transition: all 0.3s ease;">
                    <input type="checkbox" id="hubAndSpoke" checked style="opacity: 0; width: 0; height: 0;">
                    <div id="hubSpokeSlider" style="position: absolute; top: 2px; left: 2px; width: 24px; height: 24px; background: #8b5cf6; border-radius: 50%; transition: all 0.3s ease; transform: translateX(22px);"></div>
                  </div>
                  <div>
                    <div>Hub-and-Spoke Priority</div>
                    <div style="font-size: 12px; color: #64748b; font-weight: 400;">Boost hub connections vs freeform routing</div>
                  </div>
                </label>
              </div>

              <div class="setting-group" style="margin-top: 24px;">
                <label style="display: block; font-weight: 600; margin-bottom: 8px; color: #cbd5e1;">
                  Hub Priority Boost
                  <span style="color: #64748b; font-weight: 400; font-size: 12px;">(passenger routing preference)</span>
                </label>
                <div style="display: flex; align-items: center; gap: 12px;">
                  <span style="font-size: 12px; color: #64748b; min-width: 40px;">1.0x</span>
                  <input type="range" id="hubBias" min="1.0" max="3.0" step="0.2" value="1.6"
                         style="flex: 1; height: 6px; background: #374151; border-radius: 3px; outline: none; cursor: pointer;">
                  <span style="font-size: 12px; color: #64748b; min-width: 40px;">3.0x</span>
                </div>
                <div style="font-size: 11px; color: #6b7280; margin-top: 4px;">Current: <span id="hubBiasValue">1.6</span>x</div>
              </div>

              <div class="setting-group" style="margin-top: 20px;">
                <label style="display: block; font-weight: 600; margin-bottom: 8px; color: #cbd5e1;">
                  Airport Spawn Interval
                  <span style="color: #64748b; font-weight: 400; font-size: 12px;">(time between new airports)</span>
                </label>
                <div style="display: flex; align-items: center; gap: 12px;">
                  <span style="font-size: 12px; color: #64748b; min-width: 40px;">30s</span>
                  <input type="range" id="stationInterval" min="30" max="90" step="5" value="53"
                         style="flex: 1; height: 6px; background: #374151; border-radius: 3px; outline: none; cursor: pointer;">
                  <span style="font-size: 12px; color: #64748b; min-width: 40px;">90s</span>
                </div>
                <div style="font-size: 11px; color: #6b7280; margin-top: 4px;">Current: <span id="stationIntervalValue">53</span>s</div>
              </div>
            </div>
          </div>

          <!-- Preset Buttons -->
          <div style="margin-top: 30px; padding-top: 20px; border-top: 1px solid rgba(255,255,255,0.1);">
            <h4 style="color: #cbd5e1; margin: 0 0 12px 0;">Quick Presets:</h4>
            <div style="display: flex; gap: 12px; flex-wrap: wrap;">
              <button id="presetEasy" style="background: linear-gradient(135deg, #10b981, #059669); color: white; border: none; padding: 8px 16px; border-radius: 8px; font-weight: 600; cursor: pointer; font-size: 12px;">🟢 Relaxed</button>
              <button id="presetNormal" style="background: linear-gradient(135deg, #f59e0b, #d97706); color: white; border: none; padding: 8px 16px; border-radius: 8px; font-weight: 600; cursor: pointer; font-size: 12px;">🟡 Balanced</button>
              <button id="presetHard" style="background: linear-gradient(135deg, #ef4444, #dc2626); color: white; border: none; padding: 8px 16px; border-radius: 8px; font-weight: 600; cursor: pointer; font-size: 12px;">🔴 Intense</button>
              <button id="presetInsane" style="background: linear-gradient(135deg, #7c3aed, #6d28d9); color: white; border: none; padding: 8px 16px; border-radius: 8px; font-weight: 600; cursor: pointer; font-size: 12px;">🟣 Expert</button>
            </div>
          </div>

          <div style="margin-top: 20px; text-align: center;">
            <button id="applySettings" style="background: linear-gradient(135deg, #0ea5a3, #059669); color: white; border: none; padding: 12px 24px; border-radius: 10px; font-weight: 700; cursor: pointer; font-size: 14px; box-shadow: 0 4px 12px rgba(14,165,163,0.3);">Apply Changes</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script type="module" src="./src/main.js"></script>
  <script>
    (function(){
      function runIfRequested(){
        try {
          const p = new URLSearchParams(location.search);
          const sim = p.get('sim');
          if (sim) {
            const weeks = parseInt(sim, 10) || 20;
            const run = async () => {
              try {
                const res = await (window.MM && window.MM.simulateWeeks ? window.MM.simulateWeeks(weeks, { log: true, yieldEveryMs: 200 }) : Promise.reject(new Error('MM not ready')));
                console.log('[Sim]', res);
                try { alert(`Sim complete: day ${res.day}, score ${res.score}, waiting ${res.waiting}, lines ${res.lines}, trains ${res.trains}, finals ${res.finals}, gameOver ${res.gameOver}`); } catch(e){}
              } catch (e) {
                console.error('Sim error', e);
                try { alert('Simulation error: ' + (e && e.message ? e.message : e)); } catch(_){}
              }
            };
            if (window.MM && window.MM.simulateWeeks) run(); else window.addEventListener('load', run);
          }
        } catch (e) { console.warn('Auto-sim check failed', e); }
      }
      if (document.readyState === 'complete' || document.readyState === 'interactive') setTimeout(runIfRequested, 0);
      else window.addEventListener('DOMContentLoaded', runIfRequested);

      // Quick hotkey: Ctrl+Shift+S runs 20-week sim
      document.addEventListener('keydown', (e)=>{
        try {
          if (e.ctrlKey && e.shiftKey && (e.key||'').toLowerCase() === 's'){
            if (window.MM && window.MM.simulateWeeks){ window.MM.simulateWeeks(20, { log:true, yieldEveryMs: 200 }); }
          }
        } catch(_){ }
      });
    })();
  </script>
</body>
</html>
